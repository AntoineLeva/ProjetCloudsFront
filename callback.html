<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipelines Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div id="user-details">
            <p id="user-name">Bonjour, <span>Utilisateur</span></p>
            <img id="user-picture" src="default-profile.png" alt="Profile Picture">
        </div>
        <button id="logout-btn" class="logout-btn">Déconnexion</button>
    </header>

    <main>
        <h2>Liste des Pipelines</h2>
        <ul id="pipeline-list" class="pipeline-list">
            <li>Chargement des pipelines...</li>
        </ul>
    
        <h3>Ajouter un nouveau Pipeline</h3>
        <form id="add-pipeline-form">
            <label for="repo-url">URL du Repository Git :</label>
            <input type="url" id="repo-url" placeholder="https://github.com/user/repo" required>    
            <button type="submit">Ajouter Pipeline</button>
        </form>
    </main>    
    
</body>
<script>
    // Déclaration de pipelines au niveau global
    let pipelines = [];

    // Récupérer le hash de l'URL
    const hash = window.location.hash;
    const params = new URLSearchParams(hash.substring(1)); // Supprime le '#' du début
    const accessToken = params.get('access_token');

    if (accessToken) {
        sessionStorage.setItem('access_token', accessToken);

        fetch('https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + accessToken, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
            }
        })
        .then(response => response.json())
        .then(data => {
            // Stocker les informations utilisateur
            sessionStorage.setItem('user_name', data.name);
            sessionStorage.setItem('user_picture', data.picture);

            // Mettre à jour l'interface utilisateur
            document.getElementById('user-name').querySelector('span').textContent = data.name;
            document.getElementById('user-picture').src = data.picture;

            console.log('Utilisateur connecté:', data);
        })
        .catch(err => {
            console.error('Erreur récupération info utilisateur:', err);
        });
    }

    
    const backendUrl = "http://127.0.0.1:5001/deploy"; // URL de votre back-end

    // Fonction pour démarrer la pipeline
    function startPipeline(repoUrl, targetDir) {
        console.log("test");

        // Lancer la requête POST pour démarrer le processus de déploiement
        fetch(backendUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ repoUrl, targetDir })
        })
        .then(response => response.json())
        .then(data => {
            console.log("Démarrage du déploiement", data);
        })
        .catch(error => console.error("Erreur lors du démarrage du déploiement:", error));
    }

    // Utiliser EventSource pour recevoir des messages du serveur en temps réel
    const eventSource = new EventSource(backendUrl);

    eventSource.onmessage = function(event) {
        const logElement = document.getElementById("output-log");
        logElement.textContent += event.data + "\n";  // Affiche les messages reçus
        logElement.scrollTop = logElement.scrollHeight;  // Fait défiler vers le bas
    };

    eventSource.onerror = function() {
        console.error("Erreur de connexion avec le serveur SSE");
    };

    function loadUserInfo() {
        const userName = document.getElementById("user-name").querySelector("span");
        const userPicture = document.getElementById("user-picture");

        // Si les informations utilisateur sont déjà dans sessionStorage
        const storedName = sessionStorage.getItem('user_name');
        const storedPicture = sessionStorage.getItem('user_picture');

        if (storedName && storedPicture) {
            userName.textContent = storedName;
            userPicture.src = storedPicture;
        } else {
            // Afficher des informations par défaut
            userName.textContent = "Utilisateur";
            userPicture.src = "https://via.placeholder.com/50";
        }
    }

    // Fonction pour rendre les pipelines dans la liste
    function renderPipelines() {
        const pipelineList = document.getElementById("pipeline-list");
        pipelineList.innerHTML = ""; // Clear loading message

        pipelines.forEach(pipeline => {
            const li = document.createElement("li");
            const statusColor = 
                pipeline.status === "Running" ? "green" : 
                pipeline.status === "Failed" ? "red" : 
                "blue";

            li.innerHTML = `
                <span>${pipeline.name} (<a href="${pipeline.repo}" target="_blank">Repo</a>)</span>
                <span style="color: ${statusColor};">${pipeline.status}</span>
                <button id="execute-btn">Exécuter</button>
            `;
            pipelineList.appendChild(li);
            document.getElementById("execute-btn").addEventListener("click", startPipeline);
        });
    }

    // Fonction pour extraire le nom du repository depuis l'URL
    function extractRepoName(url) {
        const match = url.match(/\/([^\/]+)\/?$/); // Recherche le dernier segment de l'URL
        return match ? match[1] : "Repository inconnu";
    }

    // Fonction pour ajouter un nouveau pipeline
    function addPipeline(event) {
        event.preventDefault(); // Empêcher le rechargement de la page

        const repoUrl = document.getElementById("repo-url").value;

        if (repoUrl) {
            // Extraire le nom du repository
            const repoName = extractRepoName(repoUrl);

            // Ajouter le nouveau pipeline avec le statut par défaut "Pending"
            pipelines.push({ name: repoName, status: "Pending", repo: repoUrl });

            // Réinitialiser le formulaire
            document.getElementById("add-pipeline-form").reset();

            // Re-render la liste des pipelines
            renderPipelines();
        } else {
            alert("Veuillez entrer une URL valide !");
        }
    }

    // Charger les pipelines lors du chargement de la page
    window.addEventListener("DOMContentLoaded", () => {
        loadUserInfo();
        renderPipelines();

        // Écouter l'ajout d'un pipeline
        document.getElementById("add-pipeline-form").addEventListener("submit", addPipeline);
    });
</script>
</html>