<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Pipelines</title>
</head>

<body>
    <div class="pipeline-container">
        <h1>Suivi des Pipelines</h1>
        <ul id="pipeline-list"></ul>
    </div>

    <script>
        const token = sessionStorage.getItem('access_token');

        if (!token) {
            alert('Veuillez vous connecter d\'abord.');
            window.location.href = 'index.html';
        } else {
            fetch('http://localhost:3000/api/pipelines', {
                method: 'GET',
                headers: {
                    Authorization: `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(pipelines => {
                const pipelineList = document.getElementById('pipeline-list');
                pipelines.forEach(pipeline => {
                    const li = document.createElement('li');
                    li.textContent = `Pipeline: ${pipeline.name}, Status: ${pipeline.status}`;
                    pipelineList.appendChild(li);
                });
            })
            .catch(error => console.error('Erreur lors de la récupération des pipelines:', error));
        }


        fetch('http://localhost:3000/api/userinfo', {
            method: 'GET',
            headers: {
                Authorization: `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(user => {
            const roles = user.roles || [];
            const isAdmin = roles.includes('Admin');

            if (isAdmin) {
                const adminActions = document.createElement('button');
                adminActions.textContent = 'Lancer un nouveau pipeline';
                adminActions.addEventListener('click', () => {
                    // Appel backend pour démarrer un pipeline
                    fetch('http://localhost:3000/api/pipelines/start', {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    }).then(() => alert('Pipeline démarré avec succès'));
                });
                document.body.appendChild(adminActions);
            } else {
                alert('Vous n\'avez pas les permissions pour démarrer un pipeline.');
            }
        });

    </script>
</body>
</html>
